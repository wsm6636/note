---
created: 2024-04-26T09:56
updated: 2024-05-20T09:15
tags:
  - 笔记
  - 笔记/学习笔记
  - 待归档
status:
  - todo
---

> 注意重点在于调度问题等，比如吞吐量，等待，延迟等等

# 背景
> 一页就行

时间敏感网络（TSN）是IEEE 802.1 任务组开发的一套数据链路层协议规范，用于构建更可靠的、低延迟、低抖动的以太网。

TSN 的数据调度是保证时间敏感的基础，它的核心思想是基于不同的整形器（Shaper）来进行不同应用场景的流控制。

根据IEEE 802.1Q-2022标准，流量类别分为调度流量ST、音频AVB和尽力传输BE流量三类。他们的优先级也是如此。
关键流量：关键流量示例包括需要有限延迟和零拥塞丢失的工业自动化和控制流量。  
尽力而为流量：尽力而为流量由通用以太网流量组成，没有特定的服务质量(QoS)要求。  
预留流量：预留流量类型包括在具有指定带宽预留的不同时隙中分配的帧。

> IEEE 802.1Q 标准中使用了 8 个不同级别的优先级，这些优先级 分别用来标记网络流量的重要程度。
> 
> TSN 标准允许对计划流量 (ST) 进行时间隔离，该流量根据离线创建的静态计划发送。时间隔离是通过时间感知整形器 (TAS) 机制使用 TSN 交换机端口上的门操作来实现的。这保证了 ST 的时序确定性
A类和B类使用CBS机制，而BE类不使用CBS机制。 A类的优先级高于B类，BE类在网络中的优先级最低。因此，只有当没有更高优先级的流量争用链路时，才会发送 BE 流量。

# 标准介绍
一般主要包括以下几种情况。

## QAV
**基于信用的整形器 CBS（Credit-Based Shaper）** 
在《IEEE 标准 局域网和城域网 虚 拟桥接局域网 修正 12：时效性流的转发和队列增强》中规定
目标是确保在时间序列上提供音频/视频传输所需的最大带宽，而不会对同时传输的尽力而为数据流量造成明显中断。（AB类）

对不同队列赋予一个“信用值”来进行数据传输的调度
不同传输队列 的“信用值”会随着数据传输的过程而更改

基于信用的整形器将发送信用分配给具有预留带宽的数据流。发送信用的初始值为 0。

经过带宽预留的流称为 SR（Stream Reservation）class,SR class主要分为两类，classA和classB，分别代表不同类型的带宽预留数据流，classA的优先级高于classB

只要发送信用值在正范围内（≥0），就可以以更高的优先级传输保留带宽的数据帧（例如，参见第一个 AVB 帧的传输，在图 7 左侧标记为蓝色）。每次优先传输时，发送信用都会减少，直到最终达到负值范围。当发送信用处于负数范围时，保留带宽的数据帧可能不再被传输。因此，此时可以处理传输队列中的尽力而为帧。如果具有保留带宽的数据帧的传输因此而被延迟，则相应数据流的发送信用增加。结果，优先数据流的延迟以太网帧可以在尽力而为帧的传输之后被背对背地传输。这可以防止时间关键帧传输中的额外延迟。

![image.png](https://gcore.jsdelivr.net/gh/wsm6636/pic/202404291450139.png)
![image.png](https://gcore.jsdelivr.net/gh/wsm6636/pic/202405012026202.png)


## QBV
非抢占式**时间感知的整形器 TAS（Time Awareness Shaper）**
![image.png|1200](https://gcore.jsdelivr.net/gh/wsm6636/pic/202404301145980.png)

通过门控制列表（GCL）周期性的控制门的开/关。门控制列表确定哪个流量队列被允许在周期内的特定时间点传输。
网络数据包按其到达时间进行排队（即 FIFO 排队），并且以非抢占方式传输

那些需要实时传输的数据流（ST）通常被第一个安排进行传输，需要在时间调度配置时预先予以确定，而与此同时，还需要为非周期性的数据预留一个通道。注意，这里的非周期性数据并不是低优先级的，相反，它的优先级更高，一旦数据需要发送，那么就需要立刻安排调度。
也就是无论是周期性的数据还是非周期性的预留数据，都需要预留通道，TSN网络中还存在一些其他的数据，这些数据也是非周期性的，但是没有足够的预留通道，那么这时的数据传输就是“Best-eﬀort”的数据调度。

在每个周期结束前设置规定一个时间段，称 之为保护带Gurad Band，通过这一操作来确保在周期切换中 不存在有帧正在传输的现象。规定在保护带内， 不允许有新的帧开始传输，但是在保护带前已经开始传输的帧可以在保护带内继续完成传输工 作。如果端口无法确认下一帧的传输时间，则保 护带的时长应足够覆盖当前链路中最长帧的传输 时长。
![image.png](https://gcore.jsdelivr.net/gh/wsm6636/pic/202405011716502.png)


## Qbu
抢占式TAS

抢占式策略的原理是暂停非时间敏感型数据的传输过程，转而传输时间敏感型数据，时间敏感型数据传输完成后，再继续传输非时间敏感型数据。
根据IEEE 802.1Qbu，小于123字节的帧不能被抢占
在帧抢占中，时延要求敏感的帧称为高速帧 （ express ）， 其 余 的 帧 称 为 低 速 帧 或 可 抢 占 帧 （preemptable），帧抢占的原理可类比于计算机操 作系统中抢占式 CPU 调度。Express流量可以抢占可抢占流量，但它本身不能被抢占。抢占支持可以与CBS和门机制结合起来。例如，ST队列可以设置为express，而其他队列都是可抢占的。
假设当线路中有低速 帧正在传输时，一个高速帧提出传输请求，则首 先需要判断当前状态下是否允许切片操作，如果 允许切片，则在适当的位置中断低速帧的传输， 续接一个 MCRC 作为校验和，并把该低速帧已经 传输的部分作为一个完整的以太网帧。

# QCH
**周 期 性 排 队 与 转 发 机 制 整 形 器 CQF（Cyclic Queuing and Forwarding）**
CQF 整 形 器 基 于 IEEE 802.1Qch-2017《IEEE 标 准 局 域 网 和 城 域 网 网桥和桥接网络 修正 29: 循环排队和转发》。
![image.png](https://gcore.jsdelivr.net/gh/wsm6636/pic/202404301440393.png)
网络被划分为连续的等长时隙，i、i+1...、i+N，流量由交替的两个乒乓队列控制。
在时隙i，队列Q0可以接收任务但不能发送任务，Q1可以发送任务但不能排队任务。 （i+1时隙的队列控制与i时隙相反）
所以最大延迟是(h+1)l，最小延迟是(h-1)l。
h是数据帧经过的跳数，l是时隙长度。
WCRT=(h+1)l，取决于时隙长度和跳数

# QCR
**异步数据流整形器 ATS（Asynchronous Traffic Shaper）**


![image.png](https://gcore.jsdelivr.net/gh/wsm6636/pic/202405012026601.png)










