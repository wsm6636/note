---
created: 2024-04-26T09:56
updated: 2024-04-29T15:00
tags:
  - 笔记
  - 笔记/学习笔记
  - 待归档
---

> 注意重点在于调度问题等，比如吞吐量，等待，延迟等等

# 背景
一页就行
时间敏感网络（TSN）是 IEEE 802.1 任务组开发的一套数据链路层 协议规范，用于构建更可靠的、低延迟、低抖动的以太网。
![image.png](https://gcore.jsdelivr.net/gh/wsm6636/pic/202404261554921.png)

TSN 的数据调度是保证时间敏感的基础，它的核心思想是基于不同 的整形器（Shaper）来进行不同应用场景的流控制。

# 标准介绍
IEEE 802.1 提供了一 系列的标准来确保可靠性的数据传输，一般主要包括以下几种情况。

## （1）基于信用的整形器 CBS（Credit-Based Shaper）
CBS 整形器在 IEEE 802.1Qav-2009《IEEE 标准 局域网和城域网 虚 拟桥接局域网 修正 12：时效性流的转发和队列增强》中规定，它可以通 过对不同队列赋予一个“信用值”来进行数据传输的调度，不同传输队列 的“信用值”会随着数据传输的过程而自动更改，这样就会保证优先级较 低的数据也会得到数据传输的机会
CBS 整形器主要在汽车工业得到应用， 但相对工业应用而言还是具有较大的平均延迟。

## （2）时间感知的整形器 TAS（Time Awareness Shaper）
TAS 一 般 分 为 两 种： 抢 占 式 和 非 抢 占 式。 非 抢 占 式 基 于 IEEE 802.1Qbv，通过门控制列表（GCL）周期性的控制门的开 / 关
在 IEEE 802.1Qbv的实现中，那些需要实时传输的数据流通常被第一个安排进行传输，需要在时间调度配置时预先予以确定，而与此同时，还需要为非周期性的数据预留一个通道。注意，这里的非周期性数据并不是低优先级的， 相反，它的优先级更高，一旦数据需要发送，那么就需要立刻安排调度。
也就是无论是周期性的数据还是非周期性的预留数据，都需要预留通道，TSN网络中还存在一些其他的数据，这些数据也是非周期性的，但是没有足够的预留通道，那么这时的数据传输就是“Best-eﬀort”的数据调度。尽管这些数据是非周期性的，但是可能他们的优先级很高，因此，为了确保严格时间要求的数据传输，IEEE802.1Qbv给每个周期预留了一个“标准以太网”帧作为保护带宽。


## Qbu
为了节省带宽，IEEE 802.1Qbu-2016《IEEE 标准 局域网和城域网 网桥和桥接网络 修正 26: 框架优先》规定了抢占式的 TAS 整形器，在保 证时间敏感任务数据可调度的前提下，尽可能的节省带宽。
抢占式策略 的原理是暂停非时间敏感型数据的传输过程，转而传输时间敏感型数据， 时间敏感型数据传输完成后，再继续传输非时间敏感型数据，主要解决 低优先级队列对于高优先级队列传输的影响。需要注意的是，抢占式机 制需要网桥节点和终端节点支持 LLDP。

## （3）周 期 性 排 队 与 转 发 机 制 整 形 器 CQF（Cyclic Queuing and Forwarding）
CQF 整 形 器 基 于 IEEE 802.1Qch-2017《IEEE 标 准 局 域 网 和 城 域 网 网桥和桥接网络 修正 29: 循环排队和转发》。

## （4）异步数据流整形器 ATS（Asynchronous Traffic Shaper）
为了解决非周期性数据的传输零拥堵问题并且针对周期性的数据传输而言，网络的严格时钟同步和队列保护带宽等原因无法最大的使用到网络带宽，ATS进一步优化那些对于时间同步非严苛任务的带宽利用。




# TAS
时间感知调度程序（TAS）首次引入了根据传输时间对传统以太网帧的数据传输进行优先级排序的可能性，从而保证它们在定义的时间点转发和传送。
这允许提供专用时隙用于在周期内传输具有实时要求的数据包。
门控制列表确定哪个流量队列被允许在周期内的特定时间点传输。除了时间感知门的状态之外，门控制列表还指示特定条目将处于活动状态的时间长度。在图 3 右侧所示的门控制列表的情况下，该列表反映了由尽力而为阶段以及图 2 中的优先数据流量阶段组成的周期。


除了明确配置的保护带之外，时间感知调度程序还允许考虑下一个串联以太网帧的数据包长度。是立即发送还是等待下一个尽力而为时隙的决定取决于下一帧是否足够短以能够在当前时隙内完全发送。但即使采用这种机制，也可能会出现当前时隙中剩余时间不足或要传输的帧太大而无法放入数据包的情况。因此，即使采用这种机制，也不能完全避免由保护带导致的死区时间。
802.1Qbv为了确保每个时间片的报文都能传输完成，预留了一个Gurad Band，长度最大可配置为一个标准以太网帧的MTU大小约1500字节，会增加约12.5us的延时损耗。
![image.png](https://gcore.jsdelivr.net/gh/wsm6636/pic/202404291451311.png)

![image.png](https://gcore.jsdelivr.net/gh/wsm6636/pic/202404291500386.png)



# cbs
Credit-Based Shaper 是由 IEEE 802.1 工作组于 2009 年针对 TSN 的前身技术音频/视频桥接 (AVB) 开发的。


顾名思义，它主要针对音频/视频和类似的应用程序。基于信用的整形器的目标是确保在时间序列上提供音频/视频传输所需的最大带宽，而不会对同时传输的尽力而为数据流量造成明显中断。为了实现这一点，基于信用的整形器将发送信用分配给具有预留带宽的数据流。发送信用的初始值为 0。


只要发送信用值在正范围内（≥0），就可以以更高的优先级传输保留带宽的数据帧（例如，参见第一个 AVB 帧的传输，在图 7 左侧标记为蓝色）。每次优先传输时，发送信用都会减少，直到最终达到负值范围。当发送信用处于负数范围时，保留带宽的数据帧可能不再被传输。因此，此时可以处理传输队列中的尽力而为帧。如果具有保留带宽的数据帧的传输因此而被延迟，则相应数据流的发送信用增加（参见尽力而为帧的传输，在图7中标记为黑色）。结果，优先数据流的延迟以太网帧可以在尽力而为帧的传输之后被背对背地传输。这可以防止时间关键帧传输中的额外延迟。

![image.png](https://gcore.jsdelivr.net/gh/wsm6636/pic/202404291450139.png)


# QBU
802.1Qbu将数据帧分为可被抢占帧（Preemptable Frame）和快速帧（Express Frame），通常在每个交换机端口以优先级来对帧进行以上分类，即高优先级的帧可以对低优先级未传输完成的帧进行抢占发送，以减少传输延迟。抢占的规则一般通过设置最小可被抢占帧长度，例如若设置为128字节，则必须等待可被抢占帧传输完128字节才能对快速帧进行抢占发送，等快速帧发送完成后，再对被抢占帧未发送完成的部分进行发送。

