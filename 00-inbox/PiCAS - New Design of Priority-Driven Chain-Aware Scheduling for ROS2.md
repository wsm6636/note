---
created: 2024-03-27T18:55
updated: 2024-05-20T16:56
tags:
  - 笔记
  - 笔记/文献笔记
  - 待归档
status:
  - todo
---
# PiCAS: New Design of Priority-Driven Chain-Aware Scheduling for ROS2
 



**TitleTranslation:**  PiCAS：ROS2 优先级驱动链感知调度的新设计
**Journal or Conference:**   2021 IEEE 27th Real-Time and Embedded Technology and Applications Symposium (RTAS)  
**Authors:**  HyunjongChoi, YechengXiang, HyoseungKim
**Pub.date:**  2021-05
**DOI:**  10.1109/RTAS52030.2021.00028
**tags:** 
**zoterolink:**  [zotero](zotero://select/library/items/6BQDM4K6)

# 摘要

在ROS（机器人操作系统）中，时间和安全关键领域的大多数应用程序都是以具有数据依赖性的回调链的形式构建的。由于ROS在实时支持方面的缺陷，无法提供强有力的时序保证，可能会导致灾难性的结果。尽管ROS2声称增强了实时能力，但确保可预测的端到端链延迟仍然是一个具有挑战性的问题。在本文中，我们为 ROS2 框架提出了<span style="background:#ff4d4f">一种新的优先级驱动的链感知调度程序</span>，并为所提出的调度程序提供了端到端延迟分析。使用我们的调度程序，<span style="background:#ff4d4f">根据相应链的给定时序要求对回调进行优先级排序，以便可以在可预测的范围内改善关键链的端到端延迟</span>。所提出的调度设计包括考虑所有 ROS2 调度相关抽象（例如回调、节点和执行器）的优先级分配和资源分配。据我们所知，这是第一个通过提出新的调度器设计来解决 ROS2 在端到端延迟方面的固有局限性的工作。我们已经在 NVIDIA Xavier NX 上运行的 ROS2 中实现了调度程序。我们进行了案例研究和可调度性实验。结果表明，与默认的 ROS2 调度程序和现实场景中的最新工作相比，所提出的调度程序在端到端延迟方面有了显着的改善。
# 一、简介
ROS（机器人操作系统）[4]是最流行的机器人应用开源中间件框架之一。 ROS 的出现彻底改变了工业界和学术界的开发者社区，提供了大量工具、机器人系统和构建新应用程序的最佳实践 [3]。在短时间内取得如此高效的机器人软件开发成就的背后，软件的模块化和可组合性发挥了重要作用。然而，几十年来，ROS 在对计时和安全关键型应用程序的实时支持方面暴露出了缺陷。这激励了社区第二代 ROS ROS2 的开发。

ROS2[6]自2017年开始开发，主要考虑提高实时能力。尽管大多数概念继承自原始ROS框架，但ROS2采用了独特的功能，包括通过数据分发服务（DDS）进行节点间通信，这是实时数据分发的行业标准[2]。 ROS2的新架构旨在更好地支持实时机器人软件。然而，它仍然不能保证严格的时序约束，系统设计人员需要凭经验调整时序相关参数。

保证 ROS2 中安全关键应用程序的时序约束是一项至关重要的功能，因为违反这些约束可能会导致灾难性后果，例如，ROS 导航包对自动驾驶车辆的路径跟踪控制的延迟响应可能会导致追尾事故。此外，由于以下原因，提供此类时序保证也具有挑战性。首先，此类应用程序通常形成一条链，该链由一组具有数据依赖性的回调组成。因此，系统设计者需要知道链的端到端延迟的安全上限。其次，虽然许多先前的研究提出了端到端链延迟的分析技术[7,9,12,21]，但由于其独特的调度行为（由执行器和执行器等各种抽象引起），它们不能直接应用于ROS2框架。节点（详见第 III-B 节）。

据我们所知，最近唯一正式分析实时保证的 ROS2 调度架构的工作是 Casini 等人所做的研究。 [11]。他们特别专注于分析执行器内的回调链，这是 ROS2 的核心调度实体之一。它是 ROS2 实时工作的开创性成果，为研究界提供了分析基础。然而，还有许多未解决的问题，例如，它只关注执行器内的调度行为，而没有考虑多核系统中调度实体对执行器和CPU核的分配。此外，端到端延迟分析受到 ROS2 调度架构的限制，这激发了新调度器设计的开发。

在本文中，我们提出了 PiCAS，这是一种多核环境中用于 ROS2 的优先级驱动的链感知调度器。我们工作的目标是根据链的关键性和时序要求优先执行链回调，从而最大限度地减少端到端链延迟。我们在 ROS2“Eloquent Elusor”版本中实现了 PiCAS，并在真实的嵌入式平台上评估了其性能。本文的主要贡献如下： 
- 我们提出了PiCAS 的设计，包括回调的优先级分配以及多核平台中执行器的节点分配以及CPU 核的执行器分配。 PiCAS 使回调和执行器执行，同时尊重链的端到端时序要求。 
- 我们在提议的PiCAS 框架下对链的端到端延迟进行了上限分析。该分析提供了链的端到端延迟的安全界限。
- 我们使用嵌入式平台上的实际场景进行了案例研究，并使用随机工作负载进行了可调度性实验。实验结果表明，与默认的 ROS2 调度程序和最新的分析工作相比，我们提出的调度程序在端到端延迟方面有了显着的改善。

# 二.相关工作
ROS 的大多数工作都集中在提高实时功能 [26,27,29]。在[26]中，Saito 等人。提出了一种基于优先级的消息传输机制，允许发布者根据其优先级发送数据。魏等人。 [29]提出了一种混合操作系统平台，通过运行两个操作系统分别执行实时ROS节点（在Nuttx上）和非实时ROS节点（在Linux上）。在[27]中，ROSCH-G是一个可加载的内核框架，被提议作为具有CPU/GPU协调机制的ROS的实时扩展。然而，这些研究没有提供保证实时时序约束的分析方法，或者仅应用于第一代ROS。

对于 ROS2，Maruyama 等人。 [23]在不同供应商特定的 DDS 实现下对各种 QoS 配置进行了实证评估。在[16]中，测量了两个节点之间最坏情况的延迟，并在修补了 PREEMPT-RT 的 Linux 内核系统中观察了截止时间错过行为。这两项研究都使用基于测量的方法评估了 ROS2 的性能，但没有提供正式的建模或分析。

已经进行了许多研究来分析发布者-订阅者模型或读取执行-写入语义中的端到端链延迟。帕伦西亚等人。提出了分析多核系统中具有优先级约束的任务的方法 [24, 25]。在[15, 28]中，基于最坏情况的响应时间提出了捕获任务端到端延迟上限的方法。克洛达等人。 [21]，阿卜杜拉等人。 [7]和贝克尔等人。 [9]提出了在固定优先级调度下限制链的端到端延迟的分析方法。 Choi 等人的最新作品。 [12]提出了基于链的固定优先级调度来改善链的端到端延迟。然而，由于调度模型的差异，这些分析方法都不能直接应用于ROS2。

关于 ROS2 处理链延迟的文献非常有限。据我们所知，[11] 是唯一对 ROS2 调度程序进行建模并提供链响应时间分析的工作。该论文的作者研究了执行程序内的回调调度行为，并使用资源预留来模拟给定执行程序的资源可用性。分析链的端到端延迟时，首先计算由执行器内的回调组成的每个子链的响应时间，然后根据组合性能分析添加跨执行器的子链的响应时间（注册会计师）[18]。他们的方法为分析默认 ROS2 调度程序奠定了基础。然而，如<span style="background:#fff88f">何分配资源并进一步改善关键链的端到端延迟仍然是一个悬而未决的问题</span>

# 三．背景及系统模型
## A.ROS2架构
ROS2 是多层抽象的统一实现，如图 1 所示。应用程序由特定语言的客户端库（例如官方的 C++ 和 Python 以及来自 ROS 社区的许多其他编程语言）支持。 ROS 客户端库 (rcl) 提供 API 以确保用不同语言编写的程序之间的行为一致。 ROS 中间件库 (rmw) 是 rcl 和数据分发服务 (DDS) 之间的通信接口，并且是特定于 DDS 供应商实现的。 DDS是ROS2中新添加的行业标准实时通信系统，用于在节点的发布者和订阅者之间交换消息。

## B. 调度相关的抽象
ROS2 与调度相关的基本抽象包括回调、节点和执行器。
**回调**是ROS2中最小的可调度实体。 ROS2 [11]中有 5 种回调类型：计时器、订阅、服务、客户端和**可等待回调**。计时器回调定期以其自己的速率到达，即**时间触发**的。其他的则由外部事件触发，即事件触发。基本上，发布者和订阅者之间的消息传输可以通过在ROS2中实现回调函数来实现。

**节点**是回调函数的集合，由应用程序程序员组织以实现功能的模块化和逻辑分区。每个节点同时也是执行者的最小分配单元；因此，同一节点内的所有回调都由同一个执行器执行，并且不能将它们分配给两个或多个执行器。一般来说，每个应用程序由多个节点组成，每个节点有多个回调。

**执行器**是运行在CPU核心上的操作系统级可调度实体，即**线程**，并执行分配给它的回调。回调到执行器的分配是通过节点抽象完成的。<span style="background:#40a9ff">一旦节点被分配给执行器，这些节点的所有回调都将由执行器处理，无论回调的来源如何。</span>正如[11]中所报告的，执行器内的回调调度与传统的基于优先级的实时任务调度有很大不同。执行器在回调调度中具有两种独特的行为。首先，**回调的优先级由其类型决定。计时器回调始终具有最高优先级，而其他回调则按照前面介绍的顺序获得次高优先级。所有回调都是非抢占式执行的。** 其次，执行器通过与图1所示的通信中间件层（rmw）交互来更新各自队列中非定时器回调的就绪状态。这种更新发生在所有队列为空（称为轮询点）时，并且这样回调准备状态的延迟更新使得非定时器回调的优先级分配无效[11]，并让链以类似循环的方式运行。

**链**。在 ROS2 与调度相关的抽象之上，应用程序开发人员可以构建链。链是一种语义抽象，由一个或多个节点的**回调之间的消息交换定义**。 ROS2没有定义链上的任何属性，并且执行器在回调调度中没有考虑链的时间和资源需求。然而，由于链的端到端延迟对安全关键实时系统的性能有重大影响，因此本文重点关注链的调度、资源分配和分析。

**超载处理**。 ROS2 具有过载处理机制，以防计时器回调错过一个或多个周期。过载处理机制发生在定时器回调执行开始时（通过运行rcl层中的rcl_timer_call函数）。首先，通过将计时器回调的周期添加到其当前值来更新 next_call_time 变量，以便新值指示触发下一个计时器回调的时间。然后，<span style="background:#40a9ff">如果 next_call_time 晚于当前时间，则重复第一步，使其指向最早的未来时间。因此，由于过载而错过的计时器作业将被自然跳过，并且计时器回调可以在下一个未来周期执行</span>。在发生过载时，时间触发链的端到端延迟的最大延迟最多为计时器回调的一个周期，无论过去跳过了多少个计时器作业。这是因为链实例的释放时间实际上是由执行计时器回调作业并启动该链实例的周期的开始时间决定的。我们将利用此行为来捕获第 4 节引理 4 中先前链实例的最大阻塞延迟。六．请注意，这种机制类似于文献中针对错过截止日期的工作的跳过工作方法 [13,14,17,22]

## C、系统模型
<span style="background:#d3f8b6">本文考虑多核系统，其中所有 CPU 核心都以相同的固定时钟频率运行</span>。下面我们介绍回调、节点和执行器的模型。













***

# 笔记

## 1 论文创新在于

## 2 解决了什么问题

## 3 方法

## 4 不足&可继续研究

## 5 可参考

## 6 思考
