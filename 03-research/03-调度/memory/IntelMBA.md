---
created: 2023-07-08T20:33
updated: 2024-03-26T23:34
tags:
  - 笔记
  - 笔记/学习笔记
---
 
![img](https://cdn.jsdelivr.net/gh/wsm6636/pic/202302201602839.jpg)

MBA功能在内核和高速互连之间引入了可编程请求速率控制器，可以间接控制内核带宽，从而过度利用相对于其优先级的带宽。例如，可以不受限制地运行高优先级核心，但是可以限制产生过量流量的较低优先级核心以为高优先级核心提供更多带宽可用性。

 

内存带宽分配枚举

​	通过CPUID指令的子系统，与其他RDT功能类似

支持处理器上的MBA功能，如果支持MBA，则具有以下详细信息：

 \- 处理器支持的服务类别（CLOS）数量。

 \- 支持的最大MBA延迟值（也隐式提供粒度的定义）。

 \- 指示可编程的延迟值是否线性间隔。

​	

​	通过CPUID叶10H可以确定平台上是否支持MBA

![img](C:/Users/wsf/AppData/Local/Temp/ksohtml24828/wps14.jpg) 

通过CPUID叶子10H软件可以确定平台上是否支持MBA。具体来说，如图17-31所示，EBX寄存器的位3指示处理器上是否支持MBA，并且位位置（3）构成允许枚举MBA详细信息的资源ID（ResID）。例如，如果支持位3，则这意味着存在CPUID.10H。[ResID = 3]，如图17-38所示，其中提供了以下详细信息。

![img](C:/Users/wsf/AppData/Local/Temp/ksohtml24828/wps15.jpg) 

cupid -l 0x10 -s 0x1 枚举L3CAT

CPUID.(EAX=10H, ECX=ResID=1):EAX[4:0]=10	容量为掩码长度11

CPUID.(EAX=10H, ECX=1):EBX[31:0]			掩码位0x00000600

CPUID.(EAX=10H, ECX=1):ECX.CDP[bit 2]=0		不支持CDP

CPUID.(EAX=10H, ECX=1):EDX[15:0]=10		最大COS数11

支持的服务等级： 0xa00000000，0x900000000，0x800000000，0x700000000，0x600000000，0x500000000，0x400000000，0x300000000，0x200000000，0x100000000，0x000000000，

IA32_L3_QOS_MASK_n MSR掩码地址：c90，c91，c92，

c93，c94，c95，c96，c97，c98，c99，c9a

![img](https://cdn.jsdelivr.net/gh/wsm6636/pic/202302201602035.jpg) 

![img](https://cdn.jsdelivr.net/gh/wsm6636/pic/202302201602320.jpg) 

​	Cupid -l 0x10 -s 0x1 枚举L2CAT

​		不支持L2CAT

​	

每个设置位的位位置对应于资源ID（ResID），例如ResID = 1用于指示L3 CAT支持，而ResID = 2指示L2 CAT支持。 ResID也是软件查询该资源类型的CAT功能详细信息时必须使用的子叶索引（请参见图17-31）。

CPUID叶功能10H（高速缓存分配技术枚举叶cat枚举）及其子功能提供有关可用资源类型的信息，以及每种资源类型的CAT功能（参见第17.19.4.2节）。

 

CPUID.(EAX=10H, ECX=ResID=3):EAX[11:0] CPUID报告支持的最大MBA限制值减1。例如，值89表示支持最大限制值90。此外，在支持线性接口（见下文）的情况下，100减去最大限制值表示粒度，在此示例中为10％。

•CPUID.(EAX=10H, ECX=ResID=3):EBX保留。

•CPUID.(EAX=10H, ECX=ResID=3):ECX[2]报告延迟值的响应是否为线性（参见文本）。

•CPUID.(EAX=10H, ECX=ResID=3):EDX[15:0]报告该功能支持的服务等级（CLOS）数（减1）。例如，报告值15表示最多支持16个MBA CLOS。

![img](https://cdn.jsdelivr.net/gh/wsm6636/pic/202302201602445.jpg) 

MBA功能支持的CLOS数量可能与L3 CAT等其他资源一致，也可能不一致。

在RDT功能支持不同数量的CLOS的情况下，最低数值CLOS支持通用功能集，而更高CLOS可支持子集。例如，如果L3 CAT支持8个CLOS，而MBA支持4个CLOS，则所有8个CLOS都有L3 CAT掩码可用于缓存控制，但是上面的4个CLOS不提供MBA支持。在这种情况下，上面的4个CLOS不受任何节流控制。Mba是cat功能的扩展

![img](C:/Users/wsf/AppData/Local/Temp/ksohtml24828/wps19.jpg) 

cupid -l 0x10 -s 0x1 枚举MBA

CPUID.(EAX=10H, ECX=ResID=3):EAX[11:0]=89		最大延迟值90，精度10%

CPUID.(EAX=10H, ECX=ResID=3):ECX[2]=1	0100	线性

CPUID.(EAX=10H, ECX=ResID=3):EDX[15:0]=7		最大COS8

IA32_L2_QoS_Ext_BW_Thrtl_n MSR		延迟值地址d50，d51，d52，d53，d54，d55，d56，d57

延迟值	0x0，0xa，0x14，0x1e，0x28，0x32，0x3c，0x46，0x50，0x5a，

支持的服务等级：0x700000000，0x600000000，0x500000000，0x400000000，0x300000000，0x200000000，0x100000000，0x000000000

IA32_L3_QOS_MASK_n MSR掩码地址： c93，c94，c95，c96，c97，c98，c99，c9a

Sudo modprobe msr

![img](https://cdn.jsdelivr.net/gh/wsm6636/pic/202302201602685.jpg) 

![img](https://cdn.jsdelivr.net/gh/wsm6636/pic/202302201602884.jpg) 

 

内存带宽分配配置

MBA的配置包括两个过程

•线程与服务类别（CLOS）的关联 - 通过IA32_PQR_ASSOC MSR以第17.19.7.1节中所述的RDT功能以通用方式完成。与L3 CAT等功能一样，软件可以在上下文交换时更新PQR MSR的CLOS字段，以便维护软件线程与硬件上的服务类的正确关联。虽然逻辑处理器可能各自与独立的CLOS相关联，但请参阅第17.19.7.3节了解重要的使用模型注意事项（MBA功能的初始版本选择跨线程的最大延迟值）。

共享资源监视功能通过使用资源监视ID（RMID）

IA32_PQR_ASSOC.CLOS：IA32_PQR_ASSOC MSR提供一个COS字段，OS / VMM可以使用该字段将逻辑处理器分配给可用的COS。该组COS在所有分配功能中是通用的，这意味着同一处理器可能支持多个功能 在上下文交换时没有额外的软件COS管理开销。 有关详细信息，请参见第17.19.4.4节。

每个逻辑处理器在MSR位置0C8FH处包含IA32_PQR_ASSOC寄存器的实例

如果从未写入IA32_PQR_ASSOC.COS，则CAT功能默认使用COS 0

IA32_L3_MASK_n：为每种资源类型提供一系列MSR，该范围内的每个MSR为每个服务类指定软件配置的容量位掩码。对于具有高速缓存分配支持的L3，使用IA32_L3_QOS_MASK_n MSR之一指定CBM，其中“n”对应于COS支持的范围内的数字（为第n服务等级制定位容量掩码），即0和CPUID.(EAX=10H, ECX=ResID):EDX[15:0]之间的范围。包括在内。

读取IA32_PQR_ASSOC寄存器时，将返回内核上当前编程的COS。C8f

当读取IA32_resourceType_MASK_n寄存器时，将返回COS'n'的当前容量位掩码。C90

 

![img](C:/Users/wsf/AppData/Local/Temp/ksohtml24828/wps22.jpg) 

可以使用容量位掩码（CBM）配置每个服务等级，这些位代表容量，并指示等级之间的重叠和隔离程度

服务等级（COS）的使用在资源之间是一致的，并且COS可以附加多个资源控制属性，从而减少了上下文交换时的软件开销。例如，与其在每个资源上添加新类型的COS标签，不如说COS管理开销是恒定的。然后，硬件根据类别和与该类别关联的位掩码自动控制为指示的应用程序/线程/容器/ VM分配缓存。位掩码是通过IA32_resourceType_MASK_n MSR配置的，其中resourceType指示资源类型（例如，L3高速缓存的“ L3”），“ n”指示COS号。

MSR的层次结构保留给IA32_resourceType_MASK_n形式的高速缓存分配技术寄存器：

• 从0C90H到0D8FH（包括），提供对多个子范围的支持，以支持不同的资源类型。 第一个支持的resourceType是“L3”，对应于平台中的L3缓存。 MSR的范围从0C90H到0D0FH（含），支持最多128个L3 CAT服务等级。

可以使用标准RDMSR / WRMSR指令访问所有CAT配置寄存器

•通过表17-20中所示的IA32_L2_QoS_Ext_BW_Thrtl_n MSR设置完成每CLOS延迟值的配置。

![img](https://cdn.jsdelivr.net/gh/wsm6636/pic/202302201602512.jpg) 

MSR的基地址为D50H，该范围对应于CPUID中支持的最大CLOS，如第17.19.7.1节所述。例如，如果支持16个CLOS，则有效的MSR范围将从D50H延伸到D5F

如果CPUID指示线性输入限制值，则支持从零到CPUID的MBA_MAX字段的值作为输入。在线性模式下，输入精度定义为100-（MBA_MAX）。 例如，如果MBA_MAX值为90，则输入精度为10％。 不是精度的偶数倍的值（例如，12％）将向下舍入（例如，应用10％的延迟）。如果不支持线性值（CPUID）则输入延迟值为从0到从CPUID的MBA_MAX值的2次幂。在这种情况下，任何不是2的幂的值都将向下舍入下一个最接近的2的幂。

内存带宽分配使用注意事项

由于MBA提供的内存带宽控制是间接和近似的，因此使用带有闭环控制器的功能来监控内存带宽以及应用程序如何有效地使用缓存（通过缓存监控技术功能）可以提供额外的价值。此方法还允许管理员提供带宽目标或设定点，控制器可以使用该目标或设定点来指导应用的MBA限制值，这允许带宽控制独立于应用程序的执行特征。

由于每个处理器核心提供控制（应用于核心的每线程CLOS的最大延迟值），应注意调度线程，以免不小心放置高优先级线程（零预期MBA限制） 在低优先级线程（具有预期的MBA限制）旁边，这将导致无意中限制高优先级线程



用memtest测试：

将内核0-7划分为cos0-7

延迟值设置：0-90（精度10）

服务器整体cache11m

让缓存不命中

理论最高内存带宽20g/s？

 

配置每cos的缓存（容量掩码）——划分等级（连续的1）

 

 

单独内核测试，不划分等级：

延迟值为0内存带宽：不受限制

延迟值为10：与0延迟对比

延迟值为20：

延迟值为30：

延迟值为40：

延迟值为50：

延迟值为60：

延迟值为70：

延迟值为80

延迟值为90

 

 

 

多内核测试，划分等级：

但是cache设置不命中，只为了分级？是否有显著影响

延迟值为0内存带宽：不受限制

延迟值为10：

延迟值为20：

延迟值为30：

延迟值为40：

延迟值为50：

延迟值为60：

延迟值为70：

延迟值为80

延迟值为90

 