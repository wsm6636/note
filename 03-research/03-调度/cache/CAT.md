---
created: 2023-07-08T20:33
updated: 2024-03-26T23:34
tags:
  - 笔记
  - 笔记/学习笔记
---

## 英特尔资源总监技术（Intel RDT）

功能集提供了一组分配（资源控制）功能，包括缓存分配技术（CAT）以及代码和数据优先级（CDP）。 Intel Xeon处理器E5 v4家族（以及Intel Xeon E5 v3家族中通信专用处理器的子集）引入了在L3缓存上配置和利用缓存分配技术（CAT）机制的功能。某些Intel Atom处理器还提供对L2缓存的控制支持，并具有以下功能。本章的其余部分介绍了用于缓存分配技术以及更一般的分配功能的编程接口。如本章所述，可以使用CPUID指令在软件中检测并枚举在体系结构上受支持的CAT和CDP功能。

### 17 .19.1缓存分配技术（CAT）简介

缓存分配技术使操作系统（OS），系统管理程序/虚拟机管理器（VMM）或类似的系统服务管理代理可以指定应用程序可以填充的缓存空间量（作为对硬件的提示-某些功能，例如电源管理可能会覆盖CAT设置）。尽管不一定建议这样做，但也可以使用具有最少的OS支持的专门的用户级实现（有关Ring 3软件和虚拟来宾的信息，请参见以下OS / Hypervisor注释）。取决于处理器系列，可以提供L2或L3缓存分配功能，并且该技术旨在跨多个缓存级别和技术世代扩展。

软件可以使用CPUID以编程方式确定给定平台支持哪些级别，如以下部分所述

**本文档中定义的CAT机制具有以下主要功能：**

1. •一种枚举平台缓存分配技术功能以及提供CAT控制功能的可用资源类型的机制。对于支持缓存分配技术的实现，CPUID提供枚举支持，以查询支持哪些缓存层次结构级别以及特定的CAT功能（例如最大分配位掩码大小）。
2. •OS或Hypervisor的一种机制，用于配置缓存数量。通过分配位掩码列表可用于特定服务等级的资源；
3. •OS或Hypervisor发出信号通知应用程序所属的服务等级的机制；
4. •硬件机制，用于在指定了应用程序后指导LLC填充策略属于特定的服务等级。

请注意，对于许多用途，OS或Hypervisor可能不希望向Ring3软件或虚拟化来宾公开缓存分配技术机制。

缓存分配技术功能可根据来自执行环境的指导，使更多缓存资源（即缓存空间）可用于高优先级应用程序，如图17-26所示。该架构还允许在运行时动态分配资源，以进一步优化高优先级应用程序的性能，而对低优先级应用程序的降级最小。此外，通过管理CPUID和MSR接口，可以在OS，VMM，容器和其他方案的使用案例中重新平衡资源，以提高系统吞吐量。本节介绍平台所需的硬件和软件支持，包括执行环境（即OS / VMM）支持此类资源控制所需的条件。请注意，在图17-26中，L3缓存显示为示例资源。

### 17.19.2缓存分配技术架构

==缓存分配技术的基本目标是基于应用程序优先级或服务等级（COS或CLOS）启用资源分配。==处理器公开了一组服务等级，可以在其中分配应用程序（或单个线程）。然后，根据与应用程序或线程相关联的类，限制对它们的高速缓存分配。可以使用容量位掩码（CBM）配置每个服务等级，这些位代表容量，并指示等级之间的重叠和隔离程度。对于每个逻辑处理器，都有一个暴露的寄存器（在此称为IA32_PQR_ASSOC MSR或PQR），以允许OS / VMM在计划应用程序，线程或VM时指定COS。

**服务等级（COS）**的使用在资源之间是一致的，并且COS可以附加多个资源控制属性，从而减少了上下文交换时的软件开销。例如，与其在每个资源上添加新类型的COS标签，不如说COS管理开销是恒定的。然后，硬件根据类别和与该类别关联的位掩码自动控制为指示的应用程序/线程/容器/ VM分配缓存。位掩码是通过IA32_resourceType_MASK_n MSR配置的，其中resourceType指示资源类型（例如，L3高速缓存的“ L3”），“ n”指示COS号。

**缓存分配技术的基本要素如下：**

1. •使用CPUID指示是否支持CAT以及可以控制哪些可用资源类型的，在体系结构上公开的机制
2. •对于每个可用的resourceType，CPUID还会枚举服务类的总数以及可以使用的容量位掩码的长度用于强制为平台上的应用程序分配缓存；
3. •一种体系结构公开的机制，允许执行环境（OS / VMM）使用可用的位掩码配置不同服务类别的行为；
4. •一种体系结构公开的机制，允许执行环境（OS / VMM）将COS分配给正在执行的软件线程（即，将逻辑处理器的活动CR3与IA32_PQR_ASSOC中的COS相关联）；
5. •与实现相关的机制，指示哪个COS与内存访问相关联并强制执行基于每个COS的缓存分配。

**容量位掩码（CBM）**向硬件提供提示，指示应限制应用程序的缓存空间，并提供具有CAT功能的缓存中与竞争该缓存的其他应用程序的重叠和隔离的指示。可用的容量掩码的位长通常取决于高速缓存的配置，并在CPUID中的CAT枚举过程中指定（这在处理器系列的型号之间也可能有所不同）。同样，其他参数（例如，受支持的COS的数量）可能会因每种资源类型而异，并且可以通过CPUID枚举这些详细信息。

图17-27显示了位长度为8的样本高速缓存容量位掩码。请注意，允许所有（且仅）连续的'1'组合（例如FFFFH，0FF0H，003CH等）。尝试将值编程为不连续的“ 1”（包括零）将导致一般保护故障（#GP（0））。通常期望在基于方式的实现中，一个容量掩码位与高速缓存中的某些方式相对应，但是特定的映射取决于实现。在所有情况下，掩码位设置为“ 1”表示可以将特定的服务等级分配给该位表示的缓存子集。掩码位中的值“ 0”表示服务等级无法分配到给定的缓存子集中。通常，为给定的应用程序分配更多的缓存通常有利于其性能。

尽管CBM的表示看起来与基于方式的映射相似，但它们独立于任何特定的强制实施（例如方式分区）。相反，这是一种表示容量，重叠和缓存空间隔离的便捷方式。例如，在容量位掩码上执行POPCNT指令（设置位的填充计数）可以提供一类服务可以分配到的缓存空间的一部分。除了小数之外，位的确切位置还显示服务类别是否与其他服务类别重叠或在使用的缓存空间方面完全隔离。

图17-28显示了如何在逻辑上使用缓存容量位掩码和每个逻辑处理器服务等级来启用缓存分配技术。==允许CBM中所有（且仅）连续的1==。 CBM的长度可能因资源而异，或者在处理器代之间可能不同，并且可以使用CPUID进行枚举。从可用的掩码集中并根据OS / VMM的目标（共享或隔离的缓存等），选择位掩码并将其与不同的服务类别相关联。对于可用的服务等级，可以通过全局CAT配置寄存器集（对于L3 CAT，通过IA32_L3_MASK_n MSR，其中，“ n”是服务等级，从零开始）对关联的CBM进行编程。在所有支持CPUID的体系结构实现中，除非英特尔另行声明，否则都可以在程序执行期间动态更改CBM。

当前运行的应用程序的服务等级通过每个逻辑处理器PQR MSR（IA32_PQR_ASSOC MSR）与硬件通信。当操作系统在逻辑处理器上调度应用程序线程时，应用程序线程与特定的COS（即PQR中的相应COS）相关联，并且从该逻辑处理器对具有CAT能力的资源的所有请求都标记有该COS（换句话说，应用程序线程被配置为属于一个COS）。特定的COS）。缓存子系统使用此标记的请求信息来实施QoS。在将容量位掩码应用于分配策略之前，可以将其映射到高速缓存处的方式位掩码（或基于实现的类似实施实体）。例如，容量位掩码可以是8位掩码，并且可以使用16路位掩码来实现强制，用于基于路径分区的缓存实施。

 

### 17.19.3 代码和数据优先级（CDP）技术

代码和数据优先级技术是CAT的扩展。 

==CDP以软件可配置的方式实现代码和数据提取的隔离和单独优先级分配==，以取决于硬件支持，这可以实现工作负载优先级划分并根据工作负载的特性调整缓存容量。

CDP通过为每个服务等级（COS）提供单独的代码和数据掩码来扩展高速缓存分配技术（CAT）。

对L2 CDP功能和L3 CDP功能的支持分别枚举（通过CPUID）并单独控制（分别通过重新映射L2 CAT MSR或L3 CAT MSR）。

第17.19.6.3节和第17.19.7节分别提供了有关枚举，控制和启用L3和L2 CDP的详细信息，本节提供了一般概述。

L3 CDP功能最初是在Intel Xeon E5 v4系列服务器处理器上引入的，作为L3 CAT的扩展。

L2 CDP功能首先在未来的英特尔凌动系列处理器上引入，作为L2 CAT的扩展。

默认情况下，处理器上禁用CDP。 如果在未启用CDP的情况下使用CAT MSR，则处理器以传统的仅CAT模式运行。 

 

<font color='green'>启用CDP时</font>

1. •CAT掩码MSR被重新映射到交错的掩码MSR对中，用于数据或代码提取（见图17-29），

2. •CAT的COS范围重新编制索引，可用于CDP的COS范围的下半部分。


 

使用CDP功能，如果需要，可以在L2或L3缓存上配置代码和数据之间的虚拟隔离，类似于某些处理器缓存级别提供单独的L1数据和L1指令缓存的方式。

CDP的操作模式示例如图17-29所示。 

顶部显示的是==传统的CAT使用模型，其中容量掩码使用COS编号1：1映射==，以便能够控制给定COS（以及应用程序，线程或VM）可能占用的缓存空间。

==底部显示的是启用CDP的示例掩码配置，每个COS编号将1：2映射到两个掩码，一个用于代码，一个用于数据。==

这使得代码和数据可以在全局或基于每个COS的不同程度上重叠或隔离，具体取决于应用和系统需求。

启用CDP时，将仅拆分仅CAT操作的现有掩码空间。

例如，如果系统支持16个仅CAT的COS，**则当启用CDP时**，使用相同的MSR接口，但是一半掩码对应于代码，一半对应于数据，**COS的有效数量减少一半**。

代码/数据掩码是按COS定义的，并在MSR空间中进行交织，如后续章节所述。

如果CPUID为CAT或CDP功能公开了非偶数支持的服务类别，则使用CDP的软件应使用较低匹配的代码/数据掩码对，并且不应使用任何上部未配对掩码。

例如，如果CPUID暴露5个CLOS，则当启用CDP时，则有两个代码/数据对可用（掩码0/1表示CLOS [0]数据/代码，掩码2/3表示CLOS [1]数据/代码）， 但是不应使用上部未配对的掩码（在这种情况下为掩码4）或可能导致未定义的行为。

### 17.19.5 代码和数据优先级（CDP）：枚举和启用L3 CDP技术

L3 CDP是L3 CAT的扩展。 L3 CDP功能的存在通过CPUID.(EAX=10H,ECX=1):ECX.CDP[bit 2]枚举。（见图17-32）。适用于CAT的大多数CPUID.(EAX=10H, ECX=1)子叶数据也适用于CDP。

但是，CPUID.(EAX=10H, ECX=1):EDX.COS_MAX_CAT指定适用于仅CAT操作的最大COS。

对于CDP操作，COS_MAX_CDP等于（CPUID.(EAX=10H,ECX=1):EDX.COS_MAX_CAT >>1）。

​	如果CPUID.(EAX=10H, ECX=1):ECX.CDP[bit 2] =1，则处理器支持CDP并在地址0C81H处提供新的MSR IA32_L3_QOS_CFG。 IA32_L3_QOS_CFG的布局如图17-36所示。 IA32_L3_QOS_CFG的位字段定义是：

•位0：L3 CDP使能。 如果设置，则启用CDP，将CAT掩码MSR映射到数据掩码和代码掩码MSR对。写入IA32_PQR_ASSOC.COS的最大允许值为COS_MAX_CDP。

•比特63：1：保留。 尝试写保留位会产生#GP（0）。

IA32_L3_QOS_CFG在RESET时默认值均为0，掩码MSR均为1。 因此，所有逻辑处理器都在COS0中初始化，并在整个L3中分配CDP禁用，直到软件编程CAT和CDP。

IA32_L3_QOS_CFG MSR的范围被定义为与L3高速缓存相同的范围（例如，通常是每个处理器插槽）。

有关启用或禁用L3 CDP的软件注意事项，请参阅第17.19.7节。

==启用CDP后，将重新映射现有CAT掩码MSR空间，以便为每个COS提供代码掩码和数据掩码。==

重新映射如表17-19所示。

可以通过以下方式导出给定COS编号'n'的数据掩码或代码掩码的MSR地址：

• data_mask_address (n) = base + (n <<1), 其中base是IA32_L3_QOS_MASK_0的地址.

• code_mask_address (n) = base + (n <<1) +1.

==启用CDP时，每个COS使用掩码MSR 1：2映射，一个掩码启用对数据填充位置的编程控制，一个掩码启用对代码放置的控制。==

可以使用各种重叠和隔离的掩模配置（参见图17-29中的示例）。

掩码MSR字段定义保持不变。

==容量掩码必须由连续的设置位组成，长度为1位或更长，并且不应超过CPUID中指定的最大掩码长度。==

例如，最大位掩码长度为16b（来自CPUID）的高速缓存上的有效掩码包括0xFFFF，0xFF00,0x00FF，0x00F0,0x0001，0x0003等等。

无论CDP是启用还是禁用，最大有效掩码长度都保持不变，并且写入无效掩码值可能会导致未定义的行为。 写入保留位将生成#GP（0）。

### 17.19.4 启用缓存分配技术使用流程

图17-30说明了OS / VMM检测缓存分配技术支持和为支持CAT的资源启用基于优先级的资源分配的关键步骤。

L2 CAT的枚举和配置与L3 CAT类似，但CPUID详细信息和MSR地址不同。常用CLOS用于各功能。

 

#### 17 .19.4.1缓存分配技术的枚举和检测支持

软件可以通过执行EID = 07H，ECX = 0H的CPUID指令作为输入来查询处理器对CAT功能的支持。

如果CPUID.(EAX=07H, ECX=0):EBX.PQE[bit 15]reports 1，则处理器支持对共享处理器资源的软件控制。

软件必须使用CPUID叶10H来枚举可用资源类型，服务类和功能位掩码的其他详细信息。 Cache Allocation Technology提供的编程接口包括：

•CPUID叶功能10H（高速缓存分配技术枚举叶cat枚举）及其子功能提供有关可用资源类型的信息，以及每种资源类型的CAT功能（参见第17.19.4.2节）。

•IA32_L3_MASK_n：为每种资源类型提供一系列MSR，该范围内的每个MSR为每个服务类指定软件配置的容量位掩码。对于具有高速缓存分配支持的L3，使用IA32_L3_QOS_MASK_n MSR之一指定CBM，其中“n”对应于COS支持的范围内的数字（为第n服务等级制定位容量掩码），即0和CPUID.(EAX=10H, ECX=ResID):EDX[15:0]之间的范围。包括在内。

有关详细信息，请参见第17.19.4.3节。

•IA32_L2_MASK_n：为L2缓存分配技术提供了一系列MSR，使软件能够控制每个CLOS可用的L2缓存量。 与L3 CAT类似，使用寄存器集IA32_L2_QOS_MASK_n MSR为每个CLOS指定CBM，其中'n'的范围从零到CPUID中为L2 CAT报告的最大CLOS数。 有关详细信息，请参见第17.19.4.3节。L2掩码MSR的范围与L2缓存的级别相同（类似地，L3掩码MSR的范围与L3缓存的级别相同）。 软件可以通过执行对这些MSR之一的写入并且注意哪些逻辑线程观察到该改变来确定哪些逻辑处理器共享MSR（例如，核心本地或跨多个核共享）。 第15.5.2节“管理CMCI和机器检查资源的系统软件建议”中描述了确定寄存器范围的类似方法的示例流程。软件还可以使用CPUID叶4来确定可以共享给定级别的高速缓存的逻辑处理器ID的最大数量。

•IA32_PQR_ASSOC.CLOS：IA32_PQR_ASSOC MSR提供一个COS字段，OS / VMM可以使用该字段将逻辑处理器分配给可用的COS。该组COS在所有分配功能中是通用的，这意味着同一处理器可能支持多个功能 在上下文交换时没有额外的软件COS管理开销。 有关详细信息，请参见第17.19.4.4节。

 

#### 17 .19.4.2缓存分配技术：资源类型和功能枚举

CPUID叶子函数10H（缓存分配技术枚举叶）提供两个或更多子功能：

• CAT枚举叶子功能0枚举支持分配控制的可用资源类型，即通过执行EID = 10H和ECX = 0H的CPUID。 每个支持的资源类型由CPUID.(EAX=10H, ECX=0):EBX[31:1].中的位字段表示。每个设置位的位位置对应于资源ID（ResID），例如，ResID = 1用于指示L3 CAT支持，并且ResID = 2指示L2 CAT支持。 ResID也是软件必须用于查询该资源类型的CAT功能细节的子叶索引（参见图17-31）。

\- 对于ECX> 0，EAX [4：0]使用减一表示法报告容量位掩码长度的长度（分别为L2 CAT或L3 CAT的ECX = 1或2），例如，值15对应于容量 长度为16位的位掩码。 EAX的比特31：5被保留。

• CPUID.EAX = 10H的子功能，其中非零ECX输入与支持的ResID匹配，枚举相应ResID的特定执行细节。 枚举的功能包括容量位掩码的长度和给定ResID的服务类的数量。 软件应使用CPUID中相应的非零位报告的子叶索引来查询叶10H的子叶中支持CAT的每个可用ResID的能力。（EAX = 10H，ECX = 0）：EBX [31 ：1]以获得其他功能细节。

• L3的CAT功能由CPUID.(EAX=10H, ECX=1H)枚举，见图17-32。 CPUID.(EAX=10H, ECX=1H)报告的特定CAT功能是：

\-  CPUID.(EAX=10H, ECX=ResID=1):EAX[4:0] 使用减1表示法报告容量位掩码长度，即值15对应于长度为16位的能力位掩码。 EAX的比特31：5被保留。

\-  CPUID.(EAX=10H, ECX=1):EBX[31:0] 报告位掩码。 CBM长度内的每个设置位指示L3分配的对应单元可以由平台中的其他实体使用（例如，集成图形引擎或处理器核心外部的硬件单元并且可以直接访问L3）。 CBM长度内的每个清零位指示相应的分配单元可以被配置为实现由OS / VMM选择的基于优先级的分配方案，而不会干扰系统中的其他硬件代理。 保留CBM长度以外的比特。

\-  CPUID.(EAX=10H, ECX=1):ECX.CDP[bit 2]: 如果为1，表示支持L3代码并支持数据优先级技术（参见17.19.5节）。 CPUID的其他位。（EAX = 10H，ECX = 1）：保留ECX。

 \-  CPUID.(EAX=10H, ECX=1):EDX[15:0]报告资源支持的最大COS（COS为零参考，意味着报告值'15'表示支持的总COS为16）。 第31:16位是保留的。

 

• L2的CAT功能由CPUID.(EAX=10H, ECX=2H)枚举，见图17-33。 CPUID.(EAX=10H, ECX=2)报告的特定CAT功能是：

\-  CPUID.(EAX=10H, ECX=ResID=2):EAX[4:0]使用减1表示法报告容量位掩码长度，即值15对应于长度为16位的能力位掩码。 EAX的比特31：5被保留。

\-  CPUID.(EAX=10H, ECX=2):EBX[31:0]报告位掩码。 CBM长度内的每个设置位指示L2分配的对应单元可以由平台中的其他实体使用。 CBM长度内的每个清零位指示相应的分配单元可以被配置为实现由OS / VMM选择的基于优先级的分配方案，而不会干扰系统中的其他硬件代理。 保留CBM长度以外的比特。

\-  CPUID.(EAX=10H, ECX=2):ECX.CDP[bit 2]如果为1，表示支持L2代码和数据优先级技术（参见17.19.6节）。CPUID.(EAX=10H, ECX=2):ECX的其他位保留。

 \-  CPUID.(EAX=10H, ECX=2):EDX[15:0]报告资源支持的最大COS（COS为零参考，意味着报告的值“15”表示支持的总COS为16）。 第31:16位是保留的。

 

有关服务类别（COS）迁移的说明：软件应最大限度地减少跨逻辑处理器（跨线程或核心）的COS迁移，因为如果经常迁移COS，可能会导致缓存分配技术功能的性能降低。 这与行业标准做法一致，即尽量减少跨处理器核心的不必要的线程迁移，以避免在迁移后加热处理器缓存所花费的时间过长。 通常，为了获得最佳性能，请最小化跨处理器逻辑线程和处理器核心的线程迁移和COS迁移。

 

#### 17 .19.4.3缓存分配技术：缓存掩码配置

在确定容量位掩码（CBM）的长度和使用CPUID支持的COS数量（参见第17.19.4.2节）之后，需要使用CBM对每个COS进行编程，以通过写入相应的IA32_resourceType_MASK_n寄存器来指定其可用缓存。 'n'对应于COS支持的范围内的数字，即0和CPUID.(EAX=10H,ECX=ResID):EDX[15:0]之间的范围，包括'和'资源类型'对应于由CPUID.(EAX=10H,ECX=0):EAX[31:1]的设置位枚举的特定资源]，例如'L2'或 'L3'缓存。

MSR的层次结构保留给IA32_resourceType_MASK_n形式的高速缓存分配技术寄存器：

• 从0C90H到0D8FH（包括），提供对多个子范围的支持，以支持不同的资源类型。 第一个支持的resourceType是“L3”，对应于平台中的L3缓存。 MSR的范围从0C90H到0D0FH（含），支持最多128个L3 CAT服务等级。

• 在相同的CAT范围层次结构中，为resourceType'L2'定义另一组寄存器，对应于平台中的L2高速缓存，并且在地址0D10H到0D4FH（包括端点）的n = [0,63]定义MSR IA32_L2_MASK_n。

图17-34和图17-35提供了相关寄存器的概述。

可以使用标准RDMSR / WRMSR指令访问所有CAT配置寄存器。

请注意，一旦配置了L3或L2 CAT掩码，就可以使用IA32_PQR_ASSOC MSR将线程分组为服务等级（COS），如第17章“缓存掩码关联的服务等级：共用分配功能”中所述。

 

#### 17 .19.4.4与缓存掩码关联的服务类：跨分配的共同特征	

在使用首选容量位掩码配置可用服务类之后，OS / VMM可以在发生线程上下文切换时将逻辑处理器的IA32_PQR_ASSOC.COS设置为具有所需CBM的服务类。 这允许OS / VMM指示正在执行的线程/ VM所属的服务类别。 每个逻辑处理器在MSR位置0C8FH包含IA32_PQR_ASSOC寄存器的实例，图17-34显示该寄存器的位域布局。 位[63:32]包含每个逻辑处理器的COS字段。

请注意，将RMID字段放在同一个PQR寄存器中，可以在上下文交换时间交换RMID和CLOS，以便同时使用监视和分配功能，并提供单个寄存器写入以提高效率。

启用CDP时，在IA32_PQR_ASSOC.COS中指定COS值大于MAX_COS_CDP =(CPUID.(EAX=10H, ECX=1):EDX[15:0] >> 1)将对代码和数据提取造成不确定的性能影响。

在所有情况下，L2和L3 CDP的代码和数据掩码应至少设置一个位。

请注意，如果从未写入IA32_PQR_ASSOC.COS，则CAT功能默认使用COS 0，而COS 0又设置为IA32_L3_MASK_0中的默认掩码 - 全部为“1”（复位时）。 这实际上默认情况下会禁用强制执行功能，也不会禁用旧版操作系统和软件。

有关重要的COS编程注意事项，包括使用CAT和CDP时的最大值，请参见第17.19.7节“存储器带宽分配简介”。

### 17.19.6代码和数据优先级（CDP）：枚举和启用L2 CDP技术

L2 CDP是L2 CAT功能的扩展。 

L2 CDP功能的存在通过CPUID.(EAX=10H, ECX=2):ECX.CDP[bit 2]枚举（见图17-33）。适用于CAT的大多数CPUID.(EAX=10H, ECX=2)子叶数据也适用于CDP。但是，CPUID.(EAX=10H, ECX=2):EDX.COS_MAX_CAT指定适用于仅CAT操作的最大COS。对于CDP操作，COS_MAX_CDP等于(CPUID.(EAX=10H, ECX=2):EDX.COS_MAX_CAT >>1)。

如果CPUID.(EAX=10H, ECX=2):ECX.CDP[bit 2] =1，则处理器支持L2 CDP，并在地址0C82H处提供新的MSR IA32_L2_QOS_CFG。 IA32_L2_QOS_CFG的布局如图17-37所示。

IA32_L2_QOS_CFG的位字段定义是：

•位0：L2 CDP使能。 如果设置，则启用CDP，将CAT掩码MSR映射到数据掩码和代码掩码MSR对。写入IA32_PQR_ASSOC.COS的最大允许值为COS_MAX_CDP。

•比特63：1：保留。 尝试写保留位会产生#GP（0）。

IA32_L2_QOS_CFG在RESET处的默认值均为0，并且掩码MSR均为1。因此，所有逻辑处理器都在COS0中初始化，该COS0分配有可用的整个L2并禁用CDP，直到软件编程CAT和CDP。IA32_L2_QOS_CFG MSR定义在与L2高速缓存相同的范围内，例如通常在英特尔凌动处理器的模块级别。在具有多个模块的处理器中，为了简单起见，建议在所有模块中一致地编程IA32_L2_QOS_CFG MSR。

 

##### **L2 CDP掩码和L2 CAT掩码之间的映射**

启用CDP后，将重新映射现有CAT掩码MSR空间，以便为每个COS提供代码掩码和数据掩码。对于L3 CDP，此重映射与表17-19中所示的重映射相同，但对于L2 MSR块（IA32_L2_QOS_MASK_n）而不是L3 MSR块（IA32_L3_QOS_MASK_n）。

相同的代码/数据掩码映射算法适用于在代码和数据掩码之间重新映射MSR块。

与L3 CDP一样，当启用L2 CDP时，每个COS以掩码MSR 1：2映射，一个掩码启用对数据填充位置的编程控制，一个掩码启用对代码放置的控制。 可以使用各种重叠和隔离的掩模配置（参见图17-29中的示例）。

L2 CDP的掩码MSR字段定义与L2 CAT保持相同。 容量掩码必须由连续的设置位组成，长度为1位或更长，并且不应超过CPUID中指定的最大掩码长度。例如，最大位掩码长度为16b（来自CPUID）的高速缓存上的有效掩码包括0xFFFF，0xFF00,0x00FF，0x00F0,0x0001,0x0003等等。无论CDP是启用还是禁用，最大有效掩码长度都保持不变，并且写入无效掩码值可能会导致未定义的行为。写入保留位将生成#GP（0）。

 

##### **常见的L2和L3 CDP编程注意事项**

在启用或禁用L2或L3 CDP之前，软件应将所有1写入所有相应的CAT / CDP掩码以确保正确的行为（例如，用于L3 CAT功能的IA32_L3_QOS_Mask_n MSR集）。启用CDP时，软件还应确保仅使用在CDP操作中有效的COS编号，否则可能导致未定义的行为。例如，在具有16个CAT COS的情况下，由于在启用CDP时COS减少了一半，软件应确保在启用CDP之前仅使用COS 0-7（以及在启用或禁用CDP之前将1写入所有掩码位））。

软件还应考虑到当启用或禁用CDP时掩码解释发生变化的事实，这意味着例如当启用CDP时，给定COS的CAT掩码可能成为不同服务等级的代码掩码。为了简化此行为并防止意外重新映射，软件应考虑在启用或禁用CDP之前将所有线程重置为COS [0]。

 

 

 

##### **缓存分配技术动态配置**

除非另有说明，否则所有资源控制器技术（RDT）接口（包括IA32_PQR_ASSOC MSR，CAT / CDP掩码，MBA延迟值和CQM / MBM寄存器）在使用RDMSR / WRMSR执行期间的任何时间都可访问和修改。

写入这些MSR时，如果出现以下任何一种情况，将生成#GP（0）：

•保留位被修改，

•在支持的COS之外访问QOS掩码寄存器（最大COS编号在

CPUID.(EAX=10H, ECX=ResID):EDX[15:0]),或

•写入大于支持的最大值的COS（指定为所有有效ResID值的CPUID.(EAX=10H,ECX=ResID):EDX[15:0]的最大值）将写入IA32_PQR_ASSOC.CLOS字段。

启用CDP时，在COS空间的下半部分之外的IA32_PQR_ASSOC.COS中指定COS值。由于在启用CDP时MSR空间重新索引到代码/数据掩码中，将导致对代码和数据提取的未定义性能影响。

读取IA32_PQR_ASSOC寄存器时，将返回内核上当前编程的COS。

当读取IA32_resourceType_MASK_n寄存器时，将返回COS'n'的当前容量位掩码。

如前所述，软件应尽量减少跨逻辑处理器（跨线程或核心）的COS迁移，因为如果经常迁移COS，可能会导致缓存分配功能的准确性降低。

这与最小化跨处理器核心的不必要的线程迁移的行业标准做法一致，以避免在迁移之后花费过多的时间来加热处理器缓存。 通常，为了获得最佳性能，请最小化跨处理器逻辑线程和处理器核心的线程迁移和COS迁移。

 

##### 具有省电功能的高速缓存分配技术操作

请注意，高速缓存分配技术功能不能用于强制执行高速缓存一致性，并且某些高级电源管理功能（如可能缩小或关闭系统中各种高速缓存的C状态）可能会干扰CAT提示 - 在这种情况下，CAT位掩码 被忽略，其他功能优先。

如果需要尽可能高的CAT区分或确定性，请禁用任何缩小缓存或关闭缓存的省电功能。

电源管理接口的详细信息通常是特定于实现的，但可以在英特尔®64和IA-32架构软件开发人员手册第3C卷中找到。

如果软件需要区分线程而不是绝对确定性，那么在许多情况下，可以启用省电缓存缩减功能，这可以提供大量的功率节省并延长移动平台的电池寿命。

在这种情况下，当高速缓存断电（例如，包C状态）时，可以关闭其一部分的整个高速缓存。在恢复活动状态时，任何新的传入数据到缓存

将根据缓存容量位掩码填充。

然而，在进入空闲状态的过程期间，高速缓存收缩或断电之前的高速缓存中的任何数据可能已被刷新到存储器，并且不保证保留在高速缓存中。

如果线程之间的区别是系统软件的目标，那么这种模型可以节省大量功率，同时继续提供性能差异化。

如果系统软件需要最佳确定性，则应禁用清除部分缓存并关闭其电源的省电模式。

IA32_PQR_ASSOC在C6进入/退出时保存并恢复。 类似地，掩码寄存器内容在包C状态进入/退出时保存，并且不会丢失。

 

##### 使用其他操作模式的高速缓存分配技术操作

IA32_PQR_ASSOC和掩码寄存器中的状态在SMI传送中未经修改。

因此，SMM处理程序代码的执行可以与缓存分配技术资源交互并且向非SMM软件堆栈表现出一定程度的不确定性。

SMM处理程序还可以执行影响CAT操作的某些系统级或电源管理实践。

通过在高速缓存中保留具有专用分区的COS，SMM处理程序可以最小化对高速缓存中的数据确定性的影响。

这样的SMM处理程序可以在进入SMM后立即切换到专用COS，并在退出时切换回先前运行的COS。

 

##### 将线程与CAT / CDP服务类关联

线程通过每逻辑处理器IA32_PQR_ASSOC MSR与服务类（CLOS）相关联。相同的COS概念适用于CAT和CDP（例如，COS [5]在使用CAT或CDP时具有相同的含义，并且COS具有关联的资源使用约束属性，包括缓存容量掩码）。根据以下指导原则，在启用CDP时，COS到掩码MSR的映射确实会发生变化：

•在仅CAT模式下 - 一个掩码中的一组位掩码MSR控制代码和数据。

 \- 每个COS号码1：1在适用的资源（例如，L3缓存）上具有容量掩码。

•启用CDP时

 \- 每个COS编号都有两个掩码集，一个用于代码，一个用于数据。

 \- 代码/数据的掩码在MSR地址空间中交错（见表17-19）。

 

### 17.19.7内存带宽分配简介

内存带宽分配（MBA）功能提供对每个内核可用内存带宽的间接和近似控制，并在英特尔至强处理器可扩展系列中引入。该特征提供了一种控制应用的方法，这些应用可能在诸如数据中心的环境中相对于其优先级过度利用带宽。

MBA功能使用Resource Director Technology（RDT）功能集中的现有构造，包括服务类（CLOS）。例如，用于L3 CAT的给定CLOS意味着与用于MBA的CLOS相同。用于将线程与CLOS（IA32_PQR_ASSOC_MSR）相关联的MSR和CPUID枚举的一些元素（例如CPUID叶10H）的基础结构是共享的。

•内存带宽分配的高级实现如图17-38所示。

如图17-38所示，MBA功能在内核和高速互连之间引入了可编程请求速率控制器，可以间接控制内核带宽，从而过度利用相对于其优先级的带宽。例如，可以不受限制地运行高优先级核心，但是可以限制产生过量流量的较低优先级核心以为高优先级核心提供更多带宽可用性。

由于MBA在内核和互连之间使用可编程速率控制器，更高级别的共享高速缓存和内存控制器，这些高速缓存的带宽也可能会减少，因此应该注意仅限制不使用有效的非核心缓存的带宽密集型应用程序。

MBA公开的限制值是近似值，并根据特定的流量模式进行校准。由于工作负载特性不同，所提供的限制值可能会以不同方式影响每个工作负载。在需要精确控制的情况下，存储器带宽监视（MBM）功能可用作软件控制器的输入，该控制器决定应用MBA限制级别。

下面讨论枚举和配置细节，然后是使用模型注意事项。

 

##### 内存带宽分配枚举

与其他RDT功能类似，通过CPUID指令的子系统提供MBA功能的存在和细节的枚举。

枚举的关键组件如下。

•支持处理器上的MBA功能，如果支持MBA，则具有以下详细信息：

 \- 处理器支持的服务类别（CLOS）数量。

 \- 支持的最大MBA延迟值（也隐式提供粒度的定义）。

 \- 指示可编程的延迟值是否线性间隔。

通过执行EID = 07H，ECX = 0H作为输入的CPUID.(EAX=07H, ECX=0):EBX.PQE[bit 15]指令，可以枚举任何能够控制共享平台资源的RDT功能。如果CPUID报告1，则处理器支持对共享处理器资源的软件控制。然后，软件可以使用CPUID叶10H来枚举关于所提供的特定控件的附加细节。

通过CPUID叶10H软件可以确定平台上是否支持MBA。具体来说，如图17-31所示，EBX寄存器的第3位指示处理器是否支持MBA，位位置（3）构成资源ID（ResID），允许枚举MBA详细信息。例如，如果支持第3位，则表示存在CPUID.10H.[ResID=3]，如图17-38所示，其中提供了以下详细信息。

•CPUID报告支持的最大MBA限制值减1。例如，值89表示支持最大限制值90。此外，在支持线性接口（见下文）的情况下，100减去最大限制值表示粒度，在此示例中为10％。

•CPUID.(EAX=10H, ECX=ResID=3):EBX保留。

•CPUID.(EAX=10H, ECX=ResID=3):ECX[2]报告延迟值的响应是否为线性（参见文本）。

•CPUID.(EAX=10H, ECX=ResID=3):EDX[15:0]报告该功能支持的服务等级（CLOS）数（减1）。例如，报告值15表示最多支持16个MBA CLOS。

MBA功能支持的CLOS数量可能与L3 CAT等其他资源一致，也可能不一致。

在RDT功能支持不同数量的CLOS的情况下，最低数值CLOS支持通用功能集，而更高CLOS可支持子集。例如，如果L3 CAT支持8个CLOS，而MBA支持4个CLOS，则所有8个CLOS都有L3 CAT掩码可用于缓存控制，但是上面的4个CLOS不提供MBA支持。在这种情况下，上面的4个CLOS不受任何节流控制。

软件可以管理支持的资源/ CLOS，以便通过使用公共子集在CLOS中具有一致的功能，或者通过在需要的基础上根据仔细的CLOS和线程映射选择性地应用资源控制来实现更大的灵活性。在所有情况下，CLOS [0]都支持平台上存在的所有RDT资源控制功能。

关于MBA延迟值的解释和使用的讨论在关于MBA配置的第17.19.7.2节中提供。

 

##### 内存带宽分配配置

一旦枚举完成，MBA的配置包括两个过程。

•线程与服务类别（CLOS）的关联 - 通过IA32_PQR_ASSOC MSR以第17.19.7.1节中所述的RDT功能以通用方式完成。与L3 CAT等功能一样，软件可以在上下文交换时更新PQR MSR的CLOS字段，以便维护软件线程与硬件上的服务类的正确关联。虽然逻辑处理器可能各自与独立的CLOS相关联，但请参阅第17.19.7.3节了解重要的使用模型注意事项（MBA功能的初始版本选择跨线程的最大延迟值）。

•通过表17-20中所示的IA32_L2_QoS_Ext_BW_Thrtl_n MSR设置完成每CLOS延迟值的配置。

可编程的MBA延迟值的范围从零（表示零延迟，可用全带宽）到CPUID中指定的最大值（MBA_MAX），如第17.19.7.1节中所述。 限制值是近似值，并且在CLOS之间不总和为100％，而应将它们视为每CLOS的最大带宽“上限”。

软件可以选择MBA延迟值，然后将该值写入IA32_L2_QoS_Ext_BW_Thrtl_n MSR中的一个或多个以更新应用于特定CLOS的延迟值。如表17.20所示，MSR的基地址为D50H，该范围对应于CPUID中支持的最大CLOS，如第17.19.7.1节所述。例如，如果支持16个CLOS，则有效的MSR范围将从D50H延伸到D5F（包括端点）。

MBA延迟值MSR的定义如图17.39所示。低16位用于MBA延迟值，并且支持从CPUID MBA_MAX-1值到零的最大值。超出此范围的值将生成#GP（0）。

如果CPUID指示线性输入限制值，则支持从零到CPUID的MBA_MAX字段的值作为输入。

在线性模式下，输入精度定义为100-（MBA_MAX）。 例如，如果MBA_MAX值为90，则输入精度为10％。 不是精度的偶数倍的值（例如，12％）将向下舍入（例如，应用10％的延迟）。

•如果不支持线性值（CPUID）则输入延迟值为从0到从CPUID的MBA_MAX值的2次幂。在这种情况下，任何不是2的幂的值都将向下舍入下一个最接近的2的幂。

请注意，提供给软件的限制值是通过特定流量模式校准的，但是由于工作负载特性可能会改变响应精度，因此延迟值的线性度会因产品而异，因此应仅视为近似值。

 

##### 内存带宽分配使用注意事项

由于MBA提供的内存带宽控制是间接和近似的，因此使用带有闭环控制器的功能来监控内存带宽以及应用程序如何有效地使用缓存（通过缓存监控技术功能）可以提供额外的价值。此方法还允许管理员提供带宽目标或设定点，控制器可以使用该目标或设定点来指导应用的MBA限制值，这允许带宽控制独立于应用程序的执行特征。

由于每个处理器核心提供控制（应用于核心的每线程CLOS的最大延迟值），应注意调度线程，以免不小心放置高优先级线程（零预期MBA限制） 在低优先级线程（具有预期的MBA限制）旁边，这将导致无意中限制高优先级线程。