---
created: 2023-04-14-12:43:19
updated: 2024-03-26T23:34
tags:
  - 笔记
  - 笔记/idea
评分: ⭐⭐⭐⭐⭐
---

1. 标题：一种实时性领域的多优先级硬件定时器设计

2. 技术领域：本发明涉及实时性领域，特别是涉及硬件定时器的设计。

3. 摘要：本发明提供了一种实时性领域的多优先级硬件定时器设计，该设计包括一组硬件定时器和一个优先级控制单元。其中，每个硬件定时器可以提供不同的定时服务，并且可以被配置为不同的优先级。软件层面可以通过优先级控制单元来将所申请的硬件定时器配置为不同的优先级，并且可以在运行时动态调整硬件定时器的优先级以及定时时间。这种多优先级硬件定时器设计可以大大提高系统的灵活性和实时性，满足不同场景下的要求，具有广泛的应用前景。

4. 技术背景：在实时系统中，通常会有多个任务同时运行，这些任务有不同的优先级和执行周期。为了保证系统的实时性和可靠性，需要对任务进行严格的调度和控制。==而定时器则是实时系统中常用的一种任务调度方式==，它可以定时触发一些操作，==例如执行周期性任务、延迟等待等==。

5. > 定时器是调度方式吗？算工具吧？或者保证任务实时性的一种方式或者手段？

   传统的定时器主要分为软件定时器和硬件定时器。

   传统的定时器通常是基于软件实现的，其实现方式一般如下：

   1. 定义一个全局变量timer_counter，表示定时器计数器，用于记录系统启动以来经过的时间。初始值为0。
   2. 定义一个定时器处理函数timer_isr，用于处理定时器中断。该函数将根据定时器的设定，在定时器到达设定时间时触发中断。
   3. 定义一个定时器初始化函数timer_init，用于初始化定时器相关的参数。该函数需要设置定时器的计数模式、计数速率、定时时间等参数，以及关联定时器处理函数timer_isr。
   4. 在系统初始化时，调用定时器初始化函数timer_init进行初始化。
   5. 在系统运行时，定时器计数器timer_counter将持续不断地累加。当定时器计数器达到设定的定时时间时，定时器中断被触发，执行定时器处理函数timer_isr。
   6. 在定时器处理函数timer_isr中，根据具体的需求进行相关处理。例如，可以将定时器中断视为一个事件，通知相关的任务进行处理。

   传统软件定时器==存在有==以下一些问题：

   1. 精度问题：传统定时器的精度受到系统时钟精度和操作系统调度延迟等因素的影响，无法满足实时系统对高精度计时的需求。
   2. 管理问题：传统定时器通常是使用链表、数组和红黑树等数据结构来管理定时器，这种方式需要遍历所有定时器来查找和处理，效率较低。
   3. **优先级问题**：传统定时器通常只能支持单一优先级，无法区分不同任务的定时器的优先级，因而低优先级任务的定时器中断可能会对高优先级任务的执行造成干扰，从而影响高优先级任务的响应时间，也会影响系统的资源利用率。
   4. > 造成优先级反转，低优先级先于高优先级响应，在调度层面看相当于低优先级任务抢占了高优先级任务，影响调度性能以及实时性
   5. 安全问题：传统定时器通常是用户态的，如果定时器处理函数有问题，可能会导致系统崩溃或出现安全漏洞。
   6. 可扩展性问题：传统定时器通常只支持固定的触发方式和计时模式，无法灵活地扩展和定制。

   传统的硬件定时器通常由一个或多个计数器、一个或多个比较器和一个或多个中断控制器组成。其实现方式如下：

   1. 定义一个或多个计数器寄存器，用于计数。计数器通常是一个定长的二进制计数器，当计数器溢出时，将产生一个中断。
   2. 定义一个或多个比较器寄存器，用于设定定时器的触发时间。当计数器的值等于比较器的值时，将产生一个中断。
   3. 定义一个中断控制器，用于控制定时器中断的触发和处理。中断控制器可以接收来自计数器和比较器的中断信号，并将中断信号转发给处理器。
   4. 在系统初始化时，配置定时器的计数模式、计数速率、比较器的设定值等参数。
   5. 在系统运行时，定时器的计数器将持续不断地累加，当计数器的值等于比较器的设定值时，定时器中断将被触发。
   6. 在定时器中断处理函数中，根据具体的需求进行相关处理。例如，可以将定时器中断视为一个事件，通知相关的任务进行处理。

   传统硬件定时器存在有以下一些问题：

   1. 难以支持多任务和多优先级处理：传统的硬件定时器通常只能支持单一优先级，无法进行多优先级调度和管理，也无法区分不同任务的定时器。这使得它难以用于复杂的多任务处理系统。
   2. 难以动态调整定时器时间：传统的硬件定时器通常需要在初始化时设定定时器的触发时间，一旦设定，就无法在运行时动态调整。这使得它难以应对动态的系统需求。

   综上可知在实时系统中，定时器应具备以下特点：

   1. 高精度，能够满足微秒级的计时精度要求。
   2. 高效率，可以更高效的对定时器进行查找和处理。

   3. 支持多任务和多优先级，能够区分不同任务的定时器，并可以对不同优先级的定时器的触发进行灵活的调度和管理。

   4. 安全性，软件层面尽量在内核态进行实现，保证系统的安全。
   5. 可扩展性，能灵活的进行配置和扩展，支持多种计时模式和触发方式，能够满足不同实时任务的需求。
   6. 灵活性，在运行过程中可动态的调整定时器时间以及优先级。

6. 技术内容：该发明提出了一种实时性领域的多优先级硬件定时器设计，该设计包括一组硬件定时器和一个优先级控制单元。

   硬件定时器：如图一所示每个硬件定时器由一个公用的计时模块和一个私有的比对寄存器构成，每个硬件定时器可以提供不同的定时服务，并可以被配置为不同的优先级。计时模块和每个比对寄存器可以通过内存映射输入输出（Memory-mapped I/O，MMIO）的方式进行读写，计时模块会在被使能后以特定的频率进行计数，当计时模块中的值大于等于比对寄存器的值时便会产生对应的定时器中断。

   ![图一](./%E5%A4%9A%E4%BC%98%E5%85%88%E7%BA%A7%E7%A1%AC%E4%BB%B6%E5%AE%9A%E6%97%B6%E5%99%A8%E4%B8%93%E5%88%A9.assets/image-20230413212753343.png)

   

   优先级控制单元：优先级控制单元可以控制是否使能硬件定时器中的计时模块，同时也会接受所有来自硬件定时器的定时中断，并会根据配置信息最终确定是否产生定时器中断。如图二所示优先级控制单元包括中断仲裁模块、低优先级屏蔽寄存器、计时使能寄存器、定时器ID寄存器和数个优先级配置寄存器组成。所有寄存器均通过MMIO的方式进行读写。

   1. 中断仲裁模块实现对各个硬件定时器的中断进行仲裁，如果产生定时器中断则会将定时器ID寄存器更新为该中断的ID号。
   2. 低优先级屏蔽寄存器用来实现对低优先级定时器中断的屏蔽，当高优先级任务在执行时，会将该寄存器更新为该任务的优先级，所有低于该优先级的定时器中断都将被屏蔽。
   3. 计时器使能寄存器用来对硬件定时器中的计时模块进行使能，进而控制是否开始计时。
   4. 定时器ID寄存器会存储中断仲裁模块仲裁后的定时器中断的对应ID号，该ID号会被中断处理程序读取，用来判断该定时器中断属于哪个任务。
   5. 优先级配置寄存器用来对相应的硬件定时器进行优先级的配置，软件可以通过写入硬件定时器所对应的优先级配置寄存器来将其配置为不同的优先级，并且可以在运行时动态调整硬件定时器的优先级。同时该优先级定时器的最高位用来代表该定时器是否空闲，如果空闲，那么该定时器产生的定中断也会被屏蔽。

   ![image-20230414132727946](./%E5%A4%9A%E4%BC%98%E5%85%88%E7%BA%A7%E7%A1%AC%E4%BB%B6%E5%AE%9A%E6%97%B6%E5%99%A8%E4%B8%93%E5%88%A9.assets/image-20230414132727946.png)

   该多优先级定时器可以灵活地应用于多种处理器，甚至可以被集成到处理器的某些模块中，比如RISC-V处理器的CLINT模块中。

   接下来将以集成入CLINT模块来对整个发明如何使用进行介绍：

   CLINT模块用来对RISC-V处理器的核间中断进行处理，其中主要包括定时器中断和软件中断；但传统的CLINT只有一个硬件定时器用来产生定时器中断，我们的多优先级硬件定时器可以用来对CLINT中的硬件定时器进行扩展。

   1. 对优先级控制单元中的低优先级屏蔽寄存器、计时使能寄存器、定时器ID寄存器和优先级配置寄存器，以及硬件定时器中的比对寄存器分配相应的访问地址。其中寄存器按顺序进行编址，优先级配置寄存器也按顺序进行编址、同时每个硬件定时器的ID为从0开始按照对应比对寄存器的地址顺序从小到大进行分配。
   2. 根据分配的地址，对CLINT的访问地址重新进行分配，同时对处理器中访问CLINT的地址仲裁进行重新配置。
   3. 软件层面可以通过MMIO的方式根据分配的地址对相应的寄存器进行读写。
   4. 如果软件方面某个任务需要申请一个定时器，首先需要读取第一个硬件定时器的优先级配置寄存器，获得到该寄存器的值V<sub>1</sub>，并通过V<sub>1</sub>最高位是否为0来判断该定时器是否空闲，如果空闲则分配成功，修改该寄存器的最高位为1，同时将该定时器的优先级一同写入优先级配置寄存器；如果不空闲则访问下一个定时器的优先级配置寄存器再次进行判断，以此类推。之所以不单独设立一个模块来管理哪些硬件定时器是否空闲的原因如下：
      - 硬件定时器的数量不会很多，依次进行查找的开销不会很大。
      - 定时器一般只在任务创建之初分配一次即可，是一个低频率的操作。
      - 如果通过管理模块来对硬件定时器空闲状态进行管理的话，如果硬件定时器的数量发生变化，管理模块甚至用户代码都将面临修改，这降低了系统的兼容性和可扩展性；另外管理模块所造成的开销可能要更大。
   5. 任务申请到一个定时器后，可以通过读取当前计时模块中的计数值，根据自己的定时需求，计算并配置相应的比对寄存器，例如：计时模块的计数频率为`a` Hz，当前计时器模块的计数值为`x`，而该任务需要计时`b`s，那么将`x+a*b`的值写入相应的比对寄存器即可。
   6. 任务如果要注销一个定时器的话，只需要将对应的优先级配置寄存器的最高位配置为0即可。
   7. 如果想要屏蔽所有低优先级定时器中断所造成的干扰，在某任务占用CPU时==，则低优先级屏蔽寄存器会被配置为该任务的定时器优先级，==若新产生的硬件定时器中断的优先级比低优先级屏蔽寄存器低，那么这个定时器中断将会被屏蔽。当任务执行结束后，低优先级定时器会被配置为最新被调度的任务的定时器优先级。
   8. > 感觉不太通顺
   9. 若运行过程中需要对任务的优先级进行调整，那么可以重新对所分配的硬件定时器的优先级配置寄存器进行修改。
   10. 若运行过程中需要对定时器时间进行调整，那么可以重新对所分配的硬件定时器的比对寄存器进行修改。
   11. 一些理论研究工作存在多个周期性任务同时释放执行的需求，但实际上的硬件定时器是一直在进行计时的，这便会导致各个任务释放执行的时间并不是相同的，但通过计时使能寄存器，可以做到所有任务创建完成后再开启计时，那么便做到了多个任务同时释放执行的需求，为相关理论研究消除了多个任务释放执行时存在的误差。同时计时使能寄存器的设计使用户对定时器的运用变得更为灵活。

7. 技术优点：
   1. 高精度，与软件定时器相比，该多优先级具有高精度的特点，可以根据需求，对定时器的计时精度进行配置，上限仅受处理器的时序及硬件晶振的最高频率的限制。
   2. 高效率，无需对定时器进行查找和处理，定时器将直接由硬件进行管理，大大提高了定时器的处理效率。
   3. 支持多任务和多优先级，可以区分不同任务的定时器，也可以根据任务的不同需求进行优先级的配置，更加灵活适应各种任务的要求。同时将系统中的硬件定时器按照优先级进行分类和管理，不同优先级的定时器可以独立触发，并且中断仲裁模块可以通过判断优先级来决定是否响应对应的定时器中断，进而决定是否执行调度算法进行调度和处理。避免了低优先级任务对高优先级任务的干扰，也避免了可能出现的系统响应缓慢甚至出现死锁等问题，大大提高了系统的实时性和可靠性。
   4. 软件层面的处理函数，是在操作系统的内核上实现的，既提高了定时器的处理效率，也保证了系统的安全性。
   5. 具有灵活的配置和扩展方式，硬件方面通过类似加速器的实现方式，具有灵活可扩展的特性，用户可以根据自己的需求进行定制化的配置和调整，甚至增加新的功能；软件方面则更为灵活，用户既可以对该定时器直接进行使用，也可以基于这些定时器，进行封装，设计新的定时器库，充分发挥该定时器的特性。
   6. 可动态对计时器的时间以及优先级进行调整，避免了传统的硬件定时器所存在的问题。
   7. 计时使能寄存器的设计，使得实际进行多任务配置运行时更加符合理论研究时的假设条件，即从时间轴上同时做到了多个任务的创建和释放执行。
   8. 节省CPU资源，软件定时器需要占用CPU资源来进行计时操作，而该多优先级硬件定时器由硬件控制，不需要占用CPU资源，可以让CPU专注于其他任务的执行。
   9. 实时性强，该多优先级硬件定时器由硬件控制，不受软件的影响，可以实现更高的实时性，能够更准确地执行计时任务。
   10. 更好的资源利用率和响应时间，该多优先级硬件定时器可以更好地利用系统资源，将高优先级任务与低优先级任务进行有效区分，避免了低优先级任务对高优先级任务的干扰，提高了高优先级任务的响应时间。

