---
created: 2023-07-08T20:33
updated: 2024-02-13T22:38
tags:
  - 笔记
  - 笔记/学习笔记
---

## 一、做了什么，

在虚拟机上暂时无法实现搭建环境。

继续在服务器上运行。

Memguard控制内存带宽可以实现

使用memtest进行内存带宽数值测试

测试集按照原来的已经改写为实时任务的

## 二、要做什么，

使任务按照设定的内存带宽运行。

Memtest按照设定的内存带宽运行，并且通过memtest测试出来的结果与预设一致。

## 三、什么做不了，为什么。

### 在虚拟机上

1、Kernel panic - not syncing: Attempted to kill init! exitcode=0x00000009

可能是内存问题，内存不够，内存溢出，版本不兼容：

2、memguard能在虚拟机上正常使用吗？

（1）与版本无关，release，dev

Cpu数量1时，可以加载memguard，

但

![img](https://cdn.jsdelivr.net/gh/wsm6636/pic/202302201541611.jpg) 

 

Cpu数量2或者以上，加载memguard死机

（2）重新新建虚拟机，4核，不变

还是死机，进入内核后黑屏

（3）导入之前服务器上编译好的，可以用的内核

复制到虚拟机会出现文件缺失

### 在服务器上

3、任务不能按预期内存带宽运行

***\*需要在任务运行前改变内存带宽\****

可以有延迟

写入内存，临界值，

Throttle

回调



### Throttle

1、任务参数mem.param.mem_budget_task

传递到Litmus gsnedf，edf发给任务信号ck_stop=1暂停任务

内存带宽值传递到memguard，get_membudget更新对应内核的内存带宽值

内存带宽改完之后，Memguard返回信号到edf

Edf发信号给ck_begin=1任务继续执行任务

2、怎么暂停任务，继续让任务运行

Main函数中，在调用job前暂停任务

3、在gsnedf中

check_for_preemptions

 

 

## 四、测试实验

1、每个Task运行时，对内存带宽，周期等进行初始化，此时调度器可以获取到任务的参数。

然后连接到具体某个CPU，执行job

2、要在job执行之前，对内存带宽改变

3、用memtest在普通litmus内核下，用普通memguard，测试x

4、换成改过的内核和memguard，先变带宽然后运行job，记录运行时间y，对比时间变化

 

 

### 需要做的；

1、把memtest改成读写内存算时间的测试

2、在普通litmus内核下，普通memguard

测试memtest，5m带宽下1g内存用时a（内核带宽提前改变）

找一个占用内存多的实时任务m，运行并记录时间b（最好记录占用内存，带宽）

把memtest写进n实时任务job，同第一步，记录时间c（内核带宽提前改变）

m实时任务，限制带宽测试时间d（内核带宽提前改变）

3、在改过的内核和memguard里

m，在运行中改变内存带宽，时间e（对比bde）

n，限制内存带宽测试时间f，内存带宽在运行中改变（对比acf）

4、运行中限制内存带宽的任务用时>提前设置内核带宽的用时

差值为改变内存带宽的时间

如果时间差距很小，可能内存带宽没有在运行中改变

 

 

### 结果：

Memtest编译debug（不用perf）

1、每核带宽100m

echo mb 100 100 100 100 100 100 100 100 > /sys/kernel/debug/memguard/limit

1.1 Memtest

./memtest -a -m 2100  -c 1  -i 1 

有的CPU没有受到memguard的内存带宽限制

|       | CPU0   | CPU1   | CPU2   | CPU3   | CPU4    | CPU5   | CPU6    | CPU7    |              |
| ----- | ------ | ------ | ------ | ------ | ------- | ------ | ------- | ------- | ------------ |
| 实验1 | 0.3940 | 0.3944 | 0.3938 | 0.3937 | 20.9335 | 20.934 | 20.9379 | 20.9332 | 2100ma，100m |

 

1.2 mbw

 taskset -c 1 ./mbw -n 1 2100

| 21.172 | 21.109 | 20.973 | 20.97  | 20.979 | 20.976 | 20.971 | 20.971 | memcpy  |
| ------ | ------ | ------ | ------ | ------ | ------ | ------ | ------ | ------- |
| 15.321 | 17.88  | 42.014 | 42.015 | 42.034 | 42.02  | 42.015 | 42.014 | dumb    |
| 0.475  | 0.46   | 25.639 | 25.622 | 25.622 | 25.546 | 25.637 | 25.657 | mcblock |

 

2.1

实时任务n：将mbw写进实时任务（memtest不显示）

使用memcpy将一个数组复制到另一个数组

固定2100m

 

Sudo权限下，实时mbw显示的，与非实时（同一内核）时间不同

用mbw的计时方法：实时时间很短0.49，非实时20.97

用memtest的计时方法：实时时间很长八位数

 

Memguard，每次重启，都要重新加载

 